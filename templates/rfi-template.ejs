<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8" />
  <title>RFI Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      margin: 0;
      background: #f8f8f8;
      color: #333;
    }

.page {
  background: #fff;
  padding: 30px;
  margin-bottom: 40px;
  border-radius: 8px;
  border: 1px solid #ddd;
}

.header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 25px;
  border-bottom: 1px solid #ddd;
  padding-bottom: 10px;
}

.header-left h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.header-left p {
  margin: 3px 0;
  font-size: 12px;
}

.header-right img {
  max-width: 120px;
  height: auto;
}

.section-title {
  margin-top: 20px;
  margin-bottom: 10px;
  font-weight: bold;
  font-size: 14px;
  border-bottom: 1px solid #ddd;
  padding-bottom: 5px;
}

table.form {
  width: 100%;
  border-collapse: collapse;
}

table.form td {
  padding: 4px 0;
  vertical-align: top;
  font-size: 11px;
}

.label {
  width: 130px;
  font-weight: 600;
  font-size: 12px;
}

.field-box {
  background: #f2f2f2;
  padding: 4px;
  border-radius: 4px;
  font-size: 11px;
  border: 1px solid #ddd;
  width: 180px;
  display: inline-block;
}

/* Make wide, multi-column fields full width */
td[colspan="3"] .field-box {
  width: 100%;
}

.image-grid {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 6px;
}

.image-grid img {
  width: 180px;
  height: auto;
  border: 1px solid #ddd;
  border-radius: 6px;
}

.footer {
  margin-top: 20px;
  border-top: 1px solid #ddd;
  padding-top: 10px;
  font-size: 12px;
}

  </style>
</head>

<body>

<% dataGroupedByDrawing.forEach((item) => { %>

<div class="page">

  <!-- Header -->

  <div class="header">
    <div class="header-left">
      <h2><%= item?.drawingId?.siteId?.siteName || 'Site Name' %></h2>
      <p><%= item?.drawingId?.siteId?.siteAddress || 'Site Address' %></p>
      <p>Generated By: <%= userInfo?.name || '' %> - <%= userInfo?.department || '' %></p>
    </div>

```
<div class="header-right">
  <% if (logoPath) { %>
    <img src="<%= logoPath %>" />
  <% } %>
</div>
```

  </div>

  <!-- RFI Header Title -->

  <div class="section-title">
    RFI #<%= item?.architectRfiNo || 'N/A' %> - <%= item?.drawingId?.drawingTitle || 'N/A' %>
  </div>

  <table class="form">

```
<tr>
  <td class="label">RFI No</td>
  <td>
    <div class="field-box"><%= item?.architectRfiNo || 'N/A' %></div>
  </td>

  <td class="label">Raised Date</td>
  <td>
    <div class="field-box">
      <%= item?.requestedDate ? new Date(item.requestedDate).toLocaleDateString() : 'N/A' %>
    </div>
  </td>
</tr>

<tr>
  <td class="label">Company Name</td>
  <td>
    <div class="field-box"><%= item?.drawingId?.companyId?.companyDetails?.companyName || 'N/A' %></div>
  </td>

  <td class="label">Consultant</td>
  <td>
    <div class="field-box"><%= item?.drawingId?.designDrawingConsultant?.role || 'N/A' %></div>
  </td>
</tr>

<tr>
  <td class="label">Reviewer</td>
  <td>
    <div class="field-box"><%= item?.createdBy?.firstName || '' %> <%= item?.createdBy?.lastName || '' %></div>
  </td>

  <td class="label">Impact</td>
  <td>
    <div class="field-box"><%= item?.impactReasons?.join(", ") || 'N/A' %></div>
  </td>
</tr>

<tr>
  <td class="label">Nature of Request</td>
  <td colspan="3">
    <% if (Array.isArray(item?.natureOfRequestedInformationReasons)) { 
        const grouped = {};
        item.natureOfRequestedInformationReasons.forEach(n => {
          if (!grouped[n.natureOfRequest]) grouped[n.natureOfRequest] = [];
          grouped[n.natureOfRequest].push(n.reason);
        });
    %>
      <% Object.entries(grouped).forEach(([nature, reasons]) => { %>
        <div class="field-box" style="margin-bottom: 5px;">
          <strong><%= nature %></strong><br>
          <ul style="padding-left: 15px; margin: 2px 0;">
            <% reasons.forEach(r => { %>
              <li><%= r %></li>
            <% }) %>
          </ul>
        </div>
      <% }) %>
    <% } else { %>
      <div class="field-box">N/A</div>
    <% } %>
  </td>
</tr>

<% if (item?.pdfDrawingFileName) { %>
<tr>
  <td class="label">Attachment</td>
  <td colspan="3">
    <div class="field-box">
      <a href="<%= item.pdfDrawingFileName %>">Download File</a>
    </div>
  </td>
</tr>
<% } %>
<% if (Array.isArray(item?.reasonFileImages) && item.reasonFileImages.length > 0) { %>
<tr>
  <td class="label">Attachments</td>
  <td colspan="3">
    <div class="image-grid">
      <% item.reasonFileImages.forEach(img => { %>
        <img src="<%= img %>" />
      <% }) %>
    </div>
  </td>
</tr>
<% } %>


<tr>
  <td class="label">Expected Date</td>
  <td>
    <div class="field-box"><%= item?.expectedDate ? new Date(item.expectedDate).toLocaleDateString() : 'N/A' %></div>
  </td>

  <td class="label">Status</td>
  <td>
    <div class="field-box"><%= item?.status || 'N/A' %></div>
  </td>
</tr>

<% if (item?.acceptedDate) { %>
<tr>
  <td class="label">Document Submitted Date</td>
  <td colspan="3">
    <div class="field-box"><%= new Date(item.acceptedDate).toLocaleDateString() %></div>
  </td>
</tr>
<% } %>


  </table>

</div>
<% }) %>

</body>
</html>
