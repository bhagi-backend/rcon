<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RFI Report</title>
  <link rel="stylesheet" href="<%= cssFileUrl %>" />
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      margin: 0;
      padding: 20px;
    }
    .TableMainWrapper {
      page-break-inside: avoid;
      margin-bottom: 40px;
    }
    .SiteNameHeadingContainer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
    .RConImage img {
      max-width: 120px;
    }
    .Tableborder {
      border-top: 1px solid #000;
      margin: 10px 0;
    }
    .TableNumberTitleRevision {
      font-weight: bold;
      margin: 10px 0;
    }
    .image-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .image-item {
      width: 100px;
      height: auto;
    }
  </style>
</head>
<body>
  <% dataGroupedByDrawing.forEach((item, i) => { %>
    <div class="TableMainWrapper">

      <!-- Header -->
      <div class="SiteNameHeadingContainer">
        <div>
          <h3><%= item?.drawingId?.siteId?.siteName || 'Site Name' %></h3>
          <p><%= item?.drawingId?.siteId?.siteAddress || 'Site Address' %></p>
          <p>
            Report Generated By <%= userInfo?.name || '' %> <%= userInfo?.lastName || '' %> - <%= userInfo?.department || '' %>
          </p>
        </div>
        <div class="RConImage">
          <img src="<%= logoPath %>" alt="Logo" />
        </div>
      </div>

      <div class="Tableborder"></div>

      <div class="TableNumberTitleRevision">
        <%= item?.drawingId?.drawingNo || 'N/A' %> -
        <%= item?.drawingId?.drawingTitle || 'N/A' %> -
        <%= item?.revision || 'N/A' %>
      </div>

      <p><strong>RFI:</strong> <%= item?.architectRfiNo || 'N/A' %></p>
      <p><strong>Raised Date:</strong> <%= item?.requestedDate ? new Date(item.requestedDate).toLocaleDateString() : 'N/A' %></p>
      <p><strong>Company:</strong> <%= item?.drawingId?.companyId?.companyDetails?.companyName || 'N/A' %></p>
      <p><strong>Consultant:</strong> <%= item?.drawingId?.designDrawingConsultant?.role || 'N/A' %></p>
      <p><strong>Reviewer:</strong> <%= item?.createdBy?.firstName || '' %> <%= item?.createdBy?.lastName || '' %></p>
      <p><strong>Impact:</strong> <%= item?.impactReasons?.join(", ") || 'N/A' %></p>

      <% if (Array.isArray(item?.natureOfRequestedInformationReasons) && item.natureOfRequestedInformationReasons.length > 0) {
        const grouped = {};
        item.natureOfRequestedInformationReasons.forEach(n => {
          if (!grouped[n.natureOfRequest]) grouped[n.natureOfRequest] = [];
          grouped[n.natureOfRequest].push(n.reason);
        });
      %>
        <div>
          <p><strong>Nature of Request Reasons:</strong></p>
          <% Object.entries(grouped).forEach(([nature, reasons]) => { %>
            <p style="font-weight: 600;"><%= nature %></p>
            <ul>
              <% reasons.forEach(r => { %>
                <li><%= r %></li>
              <% }) %>
            </ul>
          <% }) %>
        </div>
      <% } %>

      <% if (item?.pdfDrawingFileName) { %>
        <p>
          <strong>Attachment:</strong>
          <a href="<%= item.pdfDrawingFileName %>">Download File</a>
        </p>
      <% } %>

      <% if (Array.isArray(item?.impactImages) && item.impactImages.length > 0) { %>
        <div class="image-grid">
          <% item.impactImages.forEach(img => { %>
            <img src="<%= img %>" alt="Impact" class="image-item" />
          <% }) %>
        </div>
      <% } %>

      <p><strong>Expected Date:</strong> <%= item?.expectedDate ? new Date(item.expectedDate).toLocaleDateString() : 'N/A' %></p>
      <p><strong>Status:</strong> <%= item?.status || 'N/A' %></p>

      <% if (item?.acceptedDate) { %>
        <p><strong>Document Submitted Date:</strong> <%= new Date(item.acceptedDate).toLocaleDateString() %></p>
      <% } %>

    </div>
  <% }) %>
</body>

</html>
